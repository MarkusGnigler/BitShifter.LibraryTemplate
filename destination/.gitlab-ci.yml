image: docker:stable

# services:
#   - docker:dind
before_script:
  - dockerd &

stages:
#if tests
  - test
#endif
  - deploy

#if tests
test-library:
  stage: test
  only:
    - master
  script:
    - docker build --tag test --file Dockerfile.Test .
    - docker run --rm --volume $CI_PROJECT_DIR/coveragereport:/source/coveragereport test
  artifacts:
    paths:
      - coveragereport
    expire_in: 1 week
#endif
release-library:
  stage: deploy
  only:
    - master
  script:
    - docker build --tag publish --file Dockerfile.Pack .
    # - dotnet nuget add source "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/nuget/index.json" --name gitlab --username gitlab-ci-token --password $CI_JOB_TOKEN --store-password-in-clear-text
    # - dotnet nuget push "Src/BitShifter.ROP/bin/Release/*.nupkg" --source gitlab
    # - docker run --rm publish --api-key $NUGET_APIKEY --source "https://api.nuget.org/v3/index.json"
    - docker run --rm publish --api-key $NUGET_APIKEY --source "$CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/nuget/index.json"